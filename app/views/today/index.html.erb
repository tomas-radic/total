<%= turbo_stream_from "matches" %>
<%= turbo_stream_from "players_open_to_play" %>

<div id="today_index_reload_notice"></div>

<section class="today base-green">
  <div class="page__content">
    <h1 class="today__heading accent-color">Topoľčianska tenisová<br>amatérska liga.</h1>
    <div class="today__brand">
      <h2>TOtal.</h2>
    </div>

    <% if selected_season.present? %>
      <div class="today__main">

        <div class="my-4">
          <%= render "today/navigation" %>
        </div>

        <div class="today__content">
          <!-- Requested matches -->
          <% if @requested_matches.any? || @rejected_matches.any? %>
            <div class="unconfirmed-matches">
              <h3 class="accent-color">Nepotvrdené výzvy</h3>
              <% @requested_matches.each do |match| %>
                <div class="today__request-link">
                  <%= link_to "#{match.side 1} vyzval/a #{match.side 2}",
                              match_path(match),
                              class: "default-color #{'u-red-bg' if policy(match).accept? || policy(match).destroy?}" %>
                </div>
              <% end %>

              <div class="mt-3">
                <% @rejected_matches.each do |match| %>
                  <div class="today__request-link">
                    <%= link_to "#{match.side 2} odmietol/la zápas s #{match.side 1}",
                                match_path(match),
                                class: "u-silver" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Players open to play -->
          <div id="players_open_to_play_top">
            <%= render partial: "shared/players_open_to_play",
                       locals: { players: @players_open_to_play } %>
          </div>
        </div>
      </div>

      <!-- Upcoming tournaments -->
      <% if @upcoming_tournaments.any? %>
        <div class="today__tournaments">
          <h3 class="accent-color today__tournaments__heading">Turnaje teraz</h3>
          <div class="today__tournaments__tiles">
            <% @upcoming_tournaments.each do |tournament| %>
              <%= render partial: "today/tournament", locals: { tournament: tournament } %>
            <% end %>
          </div>
        </div>
      <% end %>

    <% else %>
      <h3 class="today__no-season default-color">Nie je sezóna.<br>Všetci netrpezlivo čakáme.</h3>
    <% end %>
  </div>
</section>


<% if selected_season.present? %>
  <section id="recent-matches" class="today-recent base-yellow">
    <div class="page__content">
      <h3 class="today-recent__heading accent-color">Čo sa najnovšie odohralo?</h3>

      <% if @recent_matches.any? %>
        <table class="centered-table">
          <thead>
          <tr class="text-center centered-table__heading-row">
            <th>Víťaz</th>
            <th></th>
            <th>Porazený</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <% @recent_matches.each do |match| %>
            <tr class="text-center">
              <td><%= break_whitespace(match.winner) %></td>
              <td class="centered-table__increased centered-table__bordered">
                <%= link_to break_whitespace(match.result.gsub(", ", " ")), match_path(match),
                            class: "default-color" %>
              </td>
              <td><%= break_whitespace(match.looser) %></td>
              <td><%= app_date(match.date) %></td>
            </tr>
          <% end %>
          </tbody>
        </table>

        <p class="text-center my-4">
          <%= link_to "Všetky zápasy", matches_path, class: "default-color" %>
        </p>
      <% else %>
        <p class="p-8 text-center default-color">Žiadne zápasy sa v poslednej dobe nehrali.</p>
        <p class="p-2 text-center">
          <%= link_to "Zavolaj niekoho hrať!", rankings_path, class: "button button-red" %>
        </p>
      <% end %>
      <%= render "today/navigation" %>
    </div>
  </section>

  <section id="planned-matches" class="base-salmon min-h-screen px-2 py-8 md:px-8">
    <h2 class="page-heading primary-color text-right">Zápasy, ktoré uvidíme.</h2>
    <% if selected_season.present? %>
      <% if @planned_matches.any? %>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>Vyzývateľ</th>
              <th>Vyzvaný</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <% @planned_matches.each.with_index do |match, idx| %>
              <tr>
                <td>
                  <div class="fat-row">
                    <%= match.side 1 %>
                  </div>
                </td>
                <td>
                  <div class="fat-row">
                    <%= match.side 2 %>
                  </div>
                </td>
                <td class="<%= 'border-white border-solid border-t-4' if idx > 0 %>">
                  <div class="fat-row">
                    <% if match.play_date.present? %>
                      <%= link_to_match(match) do %>
                        <%= "#{app_date_span(match.play_date)}<br>#{match.play_time}<br>#{match.place&.name}".html_safe %>
                      <% end %>
                    <% else %>
                      <%= link_to_match(match) %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
        <p class="text-center pt-6">
          <%= link_to "Všetky zápasy", matches_path, class: "underline" %>
        </p>
      <% else %>
        <p class="p-8 text-center">Nikto neplánuje hrať zápas.</p>
        <p class="p-2 text-center">
          <a href="#" class="button button-red">
            Vyzvi niekoho!
          </a>
        </p>
      <% end %>

      <div id="players_open_to_play" class="text-center">
        <%= render partial: "shared/players_open_to_play",
                   locals: { players: @players_open_to_play } %>
      </div>

    <% else %>
      <p class="p-8 text-center">Zatiaľ neuvidíme žiadne, pretože nie je sezóna.</p>
    <% end %>
    <div class="underline pt-6">
      <div class="py-1"><a href="#navbar">Hore</a></div>
      <div class="py-1"><a href="#recent-matches">Posledné zápasy</a></div>
      <div class="py-1"><a href="#race">Nominácie PLAY OFF</a></div>
    </div>
  </section>


  <section id="race" class="base-red min-h-screen px-2 py-8 md:px-8">
    <h2 class="page-heading primary-color">Najväčší králi.</h2>
    <% if selected_season.present? %>
      <% if @top_rankings.any? %>

        <div class="table-container default-color">
          <table>
            <thead>
            <tr>
              <th></th>
              <th></th>
              <th>Body</th>
              <th>% výhier</th>
            </tr>
            </thead>
            <tbody>
            <% @top_rankings.each.with_index(1) do |ranking, position| %>
              <tr class="<%= ranking_row_css(selected_season, position) %>">
                <td class="<%= 'border-yellow-400 border-solid border-t-4' if position > 1 %>">
                  <%= "#{position}." %>
                </td>
                <td><%= link_to ranking[:name], player_path(ranking[:id]), class: "underline" %></td>
                <td><%= ranking[:points] %></td>
                <td><%= "#{(ranking[:percentage] / 100.0).round(2)}%" %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
        <p class="p-2 text-center default-color lg:pt-4">
          Králi s bielou farbou sú aktuálne nominovaní na PLAY OFF.
          Tí šedí, to sú princovia, majú najväčšiu šancu sa do PLAY OFF dostať.
        </p>
        <p class="text-center default-color">
          <%= link_to "Celý rebríček", rankings_path, class: "py-3 px-4 underline" %>
        </p>
      <% else %>
        <p class="p-8 text-center default-color">V rebríčku nie je nikto.</p>
        <% if true # manager_signed_in? %>
          <p class="p-2 text-center">
            <a href="#" class="button button-red">
              Administrácia
            </a>
          </p>
        <% end %>
      <% end %>
    <% else %>
      <p class="p-8 text-center default-color">V rebríčku nie je nikto, pretože nie je sezóna.</p>
    <% end %>
    <div class="underline pt-6 default-color">
      <div class="py-1"><a href="#navbar">Hore</a></div>
      <div class="py-1"><a href="#recent-matches">Posledné zápasy</a></div>
      <div class="py-1"><a href="#planned-matches">Zápasy na pláne</a></div>
    </div>
  </section>
<% end %>
